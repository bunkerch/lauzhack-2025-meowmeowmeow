<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Verification Test</title>
    <style>
        body {
            font-family: monospace;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .section {
            background: #000;
            border: 1px solid #00ff00;
            padding: 20px;
            margin: 20px 0;
        }
        h1, h2 {
            color: #00ff00;
        }
        .error {
            color: #ff0000;
        }
        .success {
            color: #00ff00;
        }
        .warning {
            color: #ffaa00;
        }
        pre {
            background: #0a0a0a;
            padding: 10px;
            overflow-x: auto;
            border-left: 3px solid #00ff00;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            font-family: monospace;
            margin: 5px;
        }
        button:hover {
            background: #00cc00;
        }
        .log {
            background: #0a0a0a;
            padding: 10px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîç QR Code Verification Test</h1>
    
    <div class="section">
        <h2>Test Data</h2>
        <pre id="testData"></pre>
    </div>

    <div class="section">
        <h2>Actions</h2>
        <button onclick="runTest()">Run Verification Test</button>
        <button onclick="runStructureTest()">Test Structure Only</button>
        <button onclick="runCryptoTest()">Test Crypto Verification</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <div class="section">
        <h2>Test Results</h2>
        <div id="results"></div>
    </div>

    <div class="section">
        <h2>Detailed Logs</h2>
        <div class="log" id="logs"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/snarkjs@0.7.0/build/snarkjs.min.js"></script>
    <script>
        // Real verification key from compiled circuit
        const verificationKey = {
            "protocol": "groth16",
            "curve": "bn128",
            "nPublic": 4,
            "vk_alpha_1": [
                "16341940248595762048265541594530231770569794186800541243314051339424804088895",
                "3515811496933937882606350217128046498180117157331869070212900468080068018529",
                "1"
            ],
            "vk_beta_2": [
                [
                    "12468673609755131754306704531949679631864409286151351630067529886272076254803",
                    "8693753153308058634949986035242941456918725299671993986500395609200829762816"
                ],
                [
                    "1178181305721482386225397576609236994087366338544956281003093898502838623053",
                    "4989121995217450427933381789716358412393701087521578385041837342222563474500"
                ],
                ["1", "0"]
            ],
            "vk_gamma_2": [
                [
                    "10857046999023057135944570762232829481370756359578518086990519993285655852781",
                    "11559732032986387107991004021392285783925812861821192530917403151452391805634"
                ],
                [
                    "8495653923123431417604973247489272438418190587263600148770280649306958101930",
                    "4082367875863433681332203403145435568316851327593401208105741076214120093531"
                ],
                ["1", "0"]
            ],
            "vk_delta_2": [
                [
                    "9102049227518487450607764428933624410043816386644838366832364005910574902403",
                    "7565561199385600057287095180396320854967594377664401655312469028085489703567"
                ],
                [
                    "13538547875163056625497636799210699131085355607806627717841859258337117889148",
                    "2798669981583959299993976723265200620535196404799481738310167234211762456800"
                ],
                ["1", "0"]
            ],
            "vk_alphabeta_12": [
                [
                    [
                        "20610641361346560264635330425919260150695500011216253683308889107576636663265",
                        "16979604561972413467816490609995465746199152824332364045968051287256540709068"
                    ],
                    [
                        "3765601064678183847746859462891442011329705991174108254980174356555450062502",
                        "14860555351067115856691354849193129672747705180320045003432204294123983985082"
                    ],
                    [
                        "12968394689973841892022803114364034575527680682583530004266234285979882175342",
                        "13923117314918155928270886188725500803590566982896007259554504846723423771632"
                    ]
                ],
                [
                    [
                        "1395103069495513479651322266957063871071638557300062808388022092521670854204",
                        "12322448929140483441286796998207887835241424793486080562554068447590422469021"
                    ],
                    [
                        "15707498899131556237657943111865781870734330846637567592811666872883407104214",
                        "2445121322492882730911076844996971719165738550354543622663780247521784555842"
                    ],
                    [
                        "15245800328947984020781110925126523235764927309504806732749312768822221773415",
                        "13834373865844965575327636077507203145061190049061504168918620988774589689486"
                    ]
                ]
            ],
            "IC": [
                [
                    "1591556238917199954381054390095637714221713564818123462537119639323618267300",
                    "12664285059468449780190042382828195712672291792639605341798986237671937423139",
                    "1"
                ],
                [
                    "4227804971537382081537448624001116558056165026302246744176215138141156832086",
                    "1477112031972151417174223067081925560885633347116012569244726820439814883241",
                    "1"
                ],
                [
                    "14356970179013557792897944203866542690812263533833761715926594417291554540362",
                    "7328261184120214431745027520828050091101332818866357670966500952635515316786",
                    "1"
                ],
                [
                    "3298083289915811437951164170713737337515951292392544121740807527643914756333",
                    "7439887273984820378867483940492985385238785231143015141018548213189146056021",
                    "1"
                ],
                [
                    "6175877238737344704535878433601844265324042056071035873386361923824178123865",
                    "16396679652501569875663794570114010704698266051163538053679817542845584629986",
                    "1"
                ]
            ]
        };
        
        // The QR code data from the user
        const testQRData = {"ticketId":"faa8355b-a411-44a0-ba1d-a88884240a91","proof":{"pi_a":["0x13bbb073b33684a622ede182618d7ee4fdc5a8e505f5f6aedf50762d347b6a9a","0xb5a062beff61b301edfcd0fdc7cdd42574dc690b03087773223112ece0b4e27","0x1"],"pi_b":[["0x2","0x3"],["0x4","0x5"],["0x1","0x0"]],"pi_c":["0x13bbb073b33684a622ede182618d7ee4fdc5a8e505f5f6aedf50762d347b6a9a","0x6","0x1"],"protocol":"groth16","curve":"bn128"},"publicSignals":["8925562350819848789148165578869344756860019928723174933653111226159106583194","3","1763769600","1763856000"],"validFrom":"2025-11-22T00:00:00.000Z","validUntil":"2025-11-23T00:00:00.000Z","routeId":3}

        // Display test data
        document.getElementById('testData').textContent = JSON.stringify(testQRData, null, 2);
        
        // Make verificationKey global for other functions
        window.verificationKey = verificationKey;

        window.log = function(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logs.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }

        window.clearLogs = function() {
            document.getElementById('logs').innerHTML = '';
            document.getElementById('results').innerHTML = '';
        }

        window.showResult = function(title, result, details) {
            const results = document.getElementById('results');
            const className = result ? 'success' : 'error';
            results.innerHTML += `
                <div class="${className}">
                    <h3>${result ? '‚úÖ' : '‚ùå'} ${title}</h3>
                    <pre>${details}</pre>
                </div>
            `;
        }

        window.runStructureTest = function() {
            window.clearLogs();
            window.log('Starting structure validation test...', 'info');

            try {
                // Check required fields
                window.log('Checking required fields...');
                const required = ['ticketId', 'proof', 'publicSignals', 'validFrom', 'validUntil', 'routeId'];
                const missing = required.filter(field => !(field in testQRData));
                
                if (missing.length > 0) {
                    window.log(`Missing fields: ${missing.join(', ')}`, 'error');
                    window.showResult('Structure Test', false, `Missing fields: ${missing.join(', ')}`);
                    return;
                }
                window.log('All required fields present', 'success');

                // Check proof structure
                window.log('Checking proof structure...');
                const proof = testQRData.proof;
                if (!proof.pi_a || !proof.pi_b || !proof.pi_c) {
                    window.log('Invalid proof structure', 'error');
                    window.showResult('Structure Test', false, 'Missing pi_a, pi_b, or pi_c');
                    return;
                }

                window.log(`pi_a length: ${proof.pi_a.length}`, 'info');
                window.log(`pi_b length: ${proof.pi_b.length}`, 'info');
                window.log(`pi_c length: ${proof.pi_c.length}`, 'info');
                window.log(`publicSignals length: ${testQRData.publicSignals.length}`, 'info');

                if (proof.pi_a.length !== 3) {
                    window.log(`pi_a should have 3 elements, has ${proof.pi_a.length}`, 'error');
                    window.showResult('Structure Test', false, `pi_a length: ${proof.pi_a.length} (expected 3)`);
                    return;
                }

                if (proof.pi_b.length !== 3) {
                    window.log(`pi_b should have 3 elements, has ${proof.pi_b.length}`, 'error');
                    window.showResult('Structure Test', false, `pi_b length: ${proof.pi_b.length} (expected 3)`);
                    return;
                }

                if (proof.pi_c.length !== 3) {
                    window.log(`pi_c should have 3 elements, has ${proof.pi_c.length}`, 'error');
                    window.showResult('Structure Test', false, `pi_c length: ${proof.pi_c.length} (expected 3)`);
                    return;
                }

                if (testQRData.publicSignals.length !== 4) {
                    window.log(`publicSignals should have 4 elements, has ${testQRData.publicSignals.length}`, 'error');
                    window.showResult('Structure Test', false, `publicSignals length: ${testQRData.publicSignals.length} (expected 4)`);
                    return;
                }

                window.log('Proof structure valid', 'success');

                // Check protocol and curve
                window.log('Checking protocol and curve...');
                if (proof.protocol !== 'groth16') {
                    window.log(`Protocol should be 'groth16', is '${proof.protocol}'`, 'error');
                    window.showResult('Structure Test', false, `Invalid protocol: ${proof.protocol}`);
                    return;
                }

                if (proof.curve !== 'bn128') {
                    window.log(`Curve should be 'bn128', is '${proof.curve}'`, 'error');
                    window.showResult('Structure Test', false, `Invalid curve: ${proof.curve}`);
                    return;
                }

                window.log('Protocol and curve valid', 'success');

                // Check dates
                window.log('Checking date validity...');
                const now = new Date();
                const validFrom = new Date(testQRData.validFrom);
                const validUntil = new Date(testQRData.validUntil);

                window.log(`Current time: ${now.toISOString()}`, 'info');
                window.log(`Valid from: ${validFrom.toISOString()}`, 'info');
                window.log(`Valid until: ${validUntil.toISOString()}`, 'info');

                if (now < validFrom) {
                    window.log('Ticket not yet valid', 'warning');
                } else if (now > validUntil) {
                    window.log('Ticket expired', 'warning');
                } else {
                    window.log('Ticket is within validity period', 'success');
                }

                window.showResult('Structure Test', true, 'All structure checks passed!');

            } catch (error) {
                window.log(`Error: ${error.message}`, 'error');
                window.showResult('Structure Test', false, error.message);
            }
        }

        window.runCryptoTest = async function() {
            window.clearLogs();
            window.log('Starting crypto verification test...', 'info');
            window.log('Verifying cryptographic proof with snarkjs...', 'info');

            try {
                const proof = testQRData.proof;
                const publicSignals = testQRData.publicSignals;

                // Convert proof to snarkjs format
                window.log('Converting proof to snarkjs format...');
                const snarkProof = {
                    pi_a: proof.pi_a.slice(0, 2),
                    pi_b: [
                        [proof.pi_b[0][1], proof.pi_b[0][0]],
                        [proof.pi_b[1][1], proof.pi_b[1][0]],
                    ],
                    pi_c: proof.pi_c.slice(0, 2),
                    protocol: proof.protocol,
                    curve: proof.curve,
                };

                window.log('Converted proof:', 'info');
                window.log(JSON.stringify(snarkProof, null, 2), 'info');

                // Prepare signals
                window.log('Preparing public signals...');
                const signals = publicSignals.map(s => s.toString());
                window.log('Public signals:', 'info');
                window.log(JSON.stringify(signals, null, 2), 'info');

                // Perform actual cryptographic verification
                window.log('Calling snarkjs.groth16.verify()...', 'info');
                
                const isValid = await window.snarkjs.groth16.verify(
                    window.verificationKey,
                    signals,
                    snarkProof
                );
                
                if (isValid) {
                    window.log('Cryptographic verification PASSED!', 'success');
                    window.showResult('Crypto Test', true, 
                        'Proof is cryptographically valid! Real snarkjs verification successful.');
                } else {
                    window.log('Cryptographic verification FAILED!', 'error');
                    window.showResult('Crypto Test', false, 
                        'Proof verification failed - invalid proof.');
                }

            } catch (error) {
                window.log(`Error: ${error.message}`, 'error');
                window.showResult('Crypto Test', false, error.message);
            }
        }

        window.runTest = function() {
            window.clearLogs();
            window.log('=== Running Full QR Code Verification Test ===', 'info');
            
            window.runStructureTest();
            
            setTimeout(() => {
                window.log('\n=== Starting Crypto Test ===\n', 'info');
                window.runCryptoTest();
            }, 500);
        }

        // Auto-run on load
        window.onload = () => {
            window.log('Test page loaded', 'success');
            window.log('Click "Run Verification Test" to start', 'info');
        };
    </script>
</body>
</html>

